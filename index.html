<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>ESP32 Irrigation</title>
    <style>
        * {margin:0; padding:0; box-sizing:border-box;}
        body {font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
              background:#f5f5f5; padding:20px;}
        .panel {background:white; border-radius:16px; padding:24px; box-shadow:0 4px 12px rgba(0,0,0,0.1);}
        h1 {font-size:20px; color:#333; text-align:center; margin-bottom:20px;}
        .status {font-size:16px; margin:12px 0; padding:12px; background:#f9f9f9; border-radius:8px;}
        .status span {font-weight:600; color:#007aff;}
        .mqtt-status {font-size:14px; text-align:center; padding:10px; border-radius:8px; font-weight:600; margin:16px 0;}
        .connected {background:#e8f5e9; color:#2e7d32;}
        .disconnected {background:#ffebee; color:#c62828;}
        .btn {width:100%; padding:14px; margin:8px 0; border:none; border-radius:8px; 
              color:white; font-size:16px; font-weight:600; cursor:pointer;}
        .btn-green {background:#34c759;}
        .btn-blue {background:#007aff;}
        .btn-red {background:#ff3b30;}
        .btn-orange {background:#ff9500;}
    </style>
</head>
<body>
    <div class="panel">
        <h1>ESP32 Irrigation</h1>
        <div class="status">Moisture: <span id="moisture">--</span></div>
        <div class="status">Pump Status: <span id="pump">--</span></div>
        <div class="status">Mode: <span id="mode">--</span></div>
        <div class="mqtt-status disconnected" id="mqttStatus">Connecting...</div>
        <button class="btn btn-green" onclick="sendCmd('irrigate')">Start Irrigation</button>
        <button class="btn btn-blue" onclick="sendCmd('auto_on')">Auto Mode ON</button>
        <button class="btn btn-red" onclick="sendCmd('auto_off')">Auto Mode OFF</button>
        <button class="btn btn-orange" onclick="sendCmd('stop')">Stop Pump</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/mqtt@4.3.7/dist/mqtt.min.js"></script>
    <script>
        // 适配iOS的MQTT连接配置（SSL加密端口）
        const client = mqtt.connect('wss://test.mosquitto.org:8081', {
            clientId: 'ios_' + Math.random().toString(16).substr(2, 8),
            clean: true,
            reconnectPeriod: 5000,
            connectTimeout: 60000,
            keepalive: 60
        });

        // 连接成功回调
        client.on('connect', () => {
            document.getElementById('mqttStatus').className = 'mqtt-status connected';
            document.getElementById('mqttStatus').textContent = 'Connected';
            client.subscribe(['esp32/irrigate/status', 'esp32/irrigate/moisture']);
        });

        // 连接失败回调
        client.on('error', (err) => {
            document.getElementById('mqttStatus').className = 'mqtt-status disconnected';
            document.getElementById('mqttStatus').textContent = 'Failed: ' + err.message;
        });

        // 接收消息回调
        client.on('message', (topic, payload) => {
            const msg = payload.toString();
            if (topic === 'esp32/irrigate/moisture') {
                document.getElementById('moisture').textContent = msg;
            }
            if (topic === 'esp32/irrigate/status') {
                // 解析状态，适配iOS显示
                if (msg.includes('Irrigation ON')) {
                    document.getElementById('pump').textContent = 'Running';
                } else if (msg.includes('Pump OFF') || msg.includes('Finished')) {
                    document.getElementById('pump').textContent = 'Stopped';
                }
                if (msg.includes('Auto Mode ON')) {
                    document.getElementById('mode').textContent = 'Auto';
                } else if (msg.includes('Manual Mode ON')) {
                    document.getElementById('mode').textContent = 'Manual';
                }
            }
        });

        // 发送指令函数
        function sendCmd(cmd) {
            if (client.connected) {
                client.publish('esp32/irrigate/control', cmd);
            } else {
                alert('MQTT not connected!');
            }
        }
    </script>
</body>
</html>